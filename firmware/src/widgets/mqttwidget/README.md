# Using MQTT Widget

To enable MQTTWidget in your setup, do the following:

## Step 1

Add the following to your config.h file
```c
#define MQTT_WIDGET_HOST "192.168.3.40"           // MQTT broker host
#define MQTT_WIDGET_PORT 1883                     // MQTT broker port
#define MQTT_SETUP_TOPIC "info-orbs/setup/orbs"   // Setup topic
#define MQTT_WIDGET_USER "user" // Leave empty if authentication is not required
#define MQTT_WIDGET_PASS "pass" // Leave empty if authentication is not required
```

## Step 2

Publish the following to the MQTT topic you defined above.
(Update the below to suit your setup:)

```json
{
  "orbs": [
    {
      "orbid": 0,
      "orbdesc": "House battery",
      "orb-bg": "TFT_SILVER",
      "orb-textcol": "TFT_BLACK",
      "topicsrc": "hamqtt/sensor/solis_battery_soc/state",
      "xpostxt": 115,
      "ypostxt": 100,
      "xposval": 130,
      "yposval": 140,
      "orbsize": 20,
      "orbvalunit": "%"
    },
    {
      "orbid": 1,
      "orbdesc": "Solar yield",
      "orb-bg": "TFT_BLACK",
      "orb-textcol": "TFT_WHITE",
      "topicsrc": "hamqtt/sensor/solis_power_generation_today/state",
      "xpostxt": 110,
      "ypostxt": 100,
      "xposval": 130,
      "yposval": 140,
      "orbsize": 20,
      "orbvalunit": "kWh"
    },
    {
      "orbid": 2,
      "orbdesc": "PV Solar Today",
      "orb-bg": "TFT_BLUE",
      "orb-textcol": "TFT_WHITE",
      "topicsrc": "hamqtt/sensor/solcast_pv_forecast_forecast_today/state",
      "xpostxt": 110,
      "ypostxt": 100,
      "xposval": 130,
      "yposval": 140,
      "orbsize": 20,
      "orbvalunit": "kWh"
    },
    {
      "orbid": 3,
      "orbdesc": "PV Solar Today+",
      "orb-bg": "TFT_BLUE",
      "orb-textcol": "TFT_WHITE",
      "topicsrc": "hamqtt/sensor/solcast_pv_forecast_forecast_tomorrow/state",
      "xpostxt": 110,
      "ypostxt": 100,
      "xposval": 130,
      "yposval": 140,
      "orbsize": 20,
      "orbvalunit": "kWh"
    },
    {
      "orbid": 4,
      "orbdesc": "Garage temp",
      "orb-bg": "TFT_BLUE",
      "orb-textcol": "TFT_WHITE",
      "topicsrc": "zigbee2mqtt/Garage Temp2",
      "xpostxt": 110,
      "ypostxt": 100,
      "xposval": 130,
      "yposval": 140,
      "orbsize": 20,
      "orbvalunit": "Â°c",
      "jsonfield": "temperature"
    }
  ]
}
```

**Note:** For Orbid 4, there's an additional jsonfield that is used to extract a value from a JSON payload returned from the topic `zigbee2mqtt/Garage Temp2`.

Example 1 payload:
```json
{
    "battery": 100,
    "humidity": 56.7,
    "linkquality": 69,
    "temperature": 17.8
}
```

To extract `temperature`, use: `"jsonfield": "temperature"`

Example 2 payload:
```json
{
    "brightness": 132,
    "linkquality": 140,
    "update": {
        "state": "idle"
    }
}
```

To extract `state`, use: `"jsonfield": "update.state"`


Example 3 payload:
```json
{
    "power_delivered": [
        {
            "value": 0.321,
            "unit": "kW"
        }
    ]
}
```

To extract `value`, use: `"jsonfield": "power_delivered[0].value"`

## Alternative: Drawscript
An alternative to the above is to use a Drawscript, which provides a simple-to-type or generate syntax that exposes the drawing functions available to the display. This enables generating the orb's UI from the host. The interpreter itself can be used by anything that can provide a string. Integrating with the mqtt widget allows extremely iterative development. To use, instead of the various parameters above, set the field `drawscript` to 1 in an orb's config. For example:
```js
{
  "orbs": [
    {
      "orbid": 0,
       "topicsrc": "info_orbs/orb0",
      "drawscript": 1
    }
    ...
```
Then the given mqtt topic contains a script of lines that indicate drawing commands, either generated by a server like a Home Assistant automation or typed interactively in a client like MQTTX. A command is word followed by a comma separated list of parameters of the form

 - number:
	 - int: 1,-5
	 - bool: string from y,n,t,f,yes,no,true,false
 - string: Hello World (use "\\," to include a comma in the string) 
 - colors:
	 - number
	 - hex 24 bit RGB: 0xrrggbb
	 - color name: red,black,orange, etc. (see the full list in Utils.cpp)
 - alignment:  string from t,c,r,tl,tc,tr,ml,mc,mr,bl,bc,br

example:

    fill,black
    line,0,0,240,240,red
    line,0,240,240,0,0xffffff
    circle,120,120,blue
    font,final
    fcolor,green
    fbcolor,black
    falign,mc
    fsize,30
    text,Howdy,120,120

Command List (some command names have short versions, like "l", for "line"):
**Fill the screen (be aware this sets text background color also)**
(also "f")

    fill,color
    ex: fill,red
**Line**
(also "l")

    line,x1,y1,x2,y2,color
    ex:line,0,0,100,100

**Circle with radius**
(also "circ","c")

    circle,x,y,r,color
    ex:circ,120,120,10,blue

**Filled circle with radius**
(also "fcirc","fc")

    fcircle,x,y,r,color
    ex:fcircle,120,120,10,green

**Rectangle**
(also "rect","r")

    rectangle,x,y,w,h,color
    ex:rect,30,30,100,100,0x00ff00
    
**Filled Rectangle**
(also "frect","fr")

    frectangle,x,y,w,h,color
    ex:frect,30,30,100,100,yellow

**Triangle**
(also "tri")

    triangle,x1,y1,x2,y2,x3,y3,color
    ex:triangle,0,239,240,239,120,0,orange

**Filled Triangle**
(also "ftri")

    ftriangle,x1,y1,x2,y2,x3,y3,color
    ex:ftriangle,0,239,240,239,120,0,orange

**Arc with outer and inner radius**
if background_color is given it is used to smooth the edges

    arc,x,y,outer_radius,inner_radius,start_angle,end_angle,color
    arc,x,y,outer_radius,inner_radius,start_angle,end_angle,color,background_color
    ex: arc,120,120,60,50,90,180,red,green

**Smooth arc with round caps**
last parameter indicates whether to add a round cap at each end

    sarc,x,y,outer_radius,inner_radius,start_angle,end_angle,color,background_color,cap
    ex: sarc,120,120,60,50,90,180,red,green,t

**Image from the filesystem**
draws a JPEG that you've added to the orb's filesystem with the web UI. scale is 1,2,4,8 to scale *down* by that much.
(also "i")

    image,x,y,filename
    image,x,y,filename,scale
    image,x,y,filename,scale,tint_color
    ex:image,0,0,/CustomClock0/8.jpg
    ex:image,120,120,/CustomClock0/8.jpg,2,blue

**Text color**
(also "fcol")

    fcolor,color
    ex:fcolor,red

**Text background color**
Used to smooth the text. Be aware that the fill command also sets this value.
(also "fbcol")

    fbcolor,color
    ex:fcolor,black

**Text alignment**
Alignment is one of these strings listed above.
(also "fa")

    falign,alignment
    ex:falign,mc

**Text height in pixels**
(also "fs")

    fsize,size
    ex:fsize,24

**Text font**
The built in font. Currently can have these values:"roboto","final","dseg7","dseg14"

    font,name
    ex:font,roboto

**Draw text**
Lots of variations allow explicit override of the various alignment, size, color, etc.. Scale is t/f indicating to use an internal scaling factor that keeps the fonts about the same size.
(also "t")

    text,string,x,y
    text,string,x,y,alignment
    text,string,x,y,alignment,color
    text,string,x,y,alignment,color,background_color
    text,string,x,y,alignment,color,background_color,scale
    ex:text,Hello There,120,120,tr

**Fitted text**
Instead of height you can specify a rectangle and the font height will be set automatically so the whole string fits in it.
(also "tf")

    textf,string,x,y,w,h
    text,string,x,y,w,h,alignment
    ex:text,Fit Me,120,120,60,60

**Centered text**
(also "tc")

    textc,string,x,y
    textc,string,x,y,size
    ex:text,Centered,120,120,100
